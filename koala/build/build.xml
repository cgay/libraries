<!--

$Id: build.xml,v 1.5 2002/07/30 03:06:20 sigue Exp $

Ant build file for the Koala HTTP server and associated libraries.

Since there's no Dylan compiler option for Ant (yet?) this is just
a way to copy files to the correct places after doing a build in
Functional Developer.

This is what the distributed directory structure is supposed to look like:
koala-x.y
  README.txt (always)
  bin        (always)
  build      (source distribution only)
  change-log.txt (always)
  config     (always)
  sources    (source distribution only)
  to-do.txt  (source distribution only)
  www        (always)

-->

<project name="koala" default="dist" basedir="../">

  <!-- set global properties for this build -->

  <!-- Set these both to the empty string if distributing a trunk version. -->
  <property name="version-prefix" value="-" />
  <property name="version" value="0.3" />

  <property name="sources" value="${basedir}/sources" />
  <property name="www"     value="${basedir}/www" />
  <property name="dist"    value="${basedir}/dist/koala${version-prefix}${version}" />
  <property name="config"  value="${basedir}/config" />


  <!-- ********** help ********** -->

  <target name="help">
    <echo message="" />
    <echo message="Usage: ant [target]" />
    <echo message="available targets are:" />
    <echo message="  dist [default] -- builds a full Koala distribution with source" />
    <echo message="  binary         -- builds a binary-only distribution" />
    <echo message="  source         -- builds a source-only distribution" />
    <echo message="  clean-all      -- cleans up the build directories" />
    <echo message="  clean-dist     -- deletes the distribution directory" />
    <echo message="  clean-binary   -- cleans binaries (koala-build etc) out of the source directories" />
    <echo message="  clean-source   -- cleans junk file out of the source directories" />
    <echo message="  help           -- display this help message" />
  </target>


  <!-- ********** dist ********** -->

  <target name="dist" depends="binary,source">
  </target>


  <!-- ********** basics ********** -->

  <!-- Builds everything that goes in both the source and binary distributions. -->

  <target name="basics">

    <mkdir dir="${dist}" />
    <mkdir dir="${dist}" />
    <mkdir dir="${dist}/www" />
    <mkdir dir="${dist}/config" />

    <copy todir="${dist}/www"
          overwrite="yes">
      <fileset dir="${www}" />
    </copy>

    <copy file="${basedir}/config/koala-config.xml"
          todir="${dist}/config"
          overwrite="yes" />

    <copy file="${basedir}/README.txt"
          todir="${dist}"
          overwrite="yes">
    </copy>

    <copy file="${basedir}/change-log.txt"
          todir="${dist}"
          overwrite="yes">
    </copy>

  </target>


  <!-- ********** binary ********** -->

  <target name="binary" depends="basics">

    <mkdir dir="${dist}/bin" />

    <copy todir="${dist}/bin"
          overwrite="yes">
      <fileset dir="${sources}/example/release" />
    </copy>

  </target>


  <!-- ********** source-only ********** -->

  <target name="source" depends="basics">

    <mkdir dir="${dist}/sources" />
    <mkdir dir="${dist}/build" />
    <mkdir dir="${dist}/lib" />
    
    <copy todir="${dist}/sources"
          overwrite="yes">
      <fileset dir="${basedir}/sources" includes="**/*.dylan, **/*.txt, **/*.lid, **/*.hdp, **/*.htm, **/*.html" />
    </copy>

    <copy todir="${dist}/lib"
          overwrite="yes">
      <fileset dir="${basedir}/lib" includes="**/*.dylan, **/*.txt, **/*.lid, **/*.hdp, **/*.htm, **/*.html" />
    </copy>

    <copy file="${basedir}/build/build.xml"
          todir="${dist}/build"
          overwrite="yes">
    </copy>

    <copy file="${basedir}/to-do.txt"
          todir="${dist}"
          overwrite="yes">
    </copy>

  </target>


  <!-- ********** cleanup targets ********** -->

  <target name="clean-all" depends="clean-dist, clean-source, clean-binary">
  </target>

  <target name="clean-dist">
    <delete dir="${basedir}/dist" />
  </target>

  <target name="clean-source">
    <delete>
      <fileset dir="${basedir}/sources"
               defaultexcludes="no"
               includes="**/*~, **/#*#, **/.#*" />
    </delete>
    <delete>
      <fileset dir="${basedir}/www"
               defaultexcludes="no"
               includes="**/*~, **/#*#, **/.#*" />
    </delete>
  </target>

  <target name="clean-binary">
    <delete dir="${sources}/koala/koala-build" />
    <delete dir="${sources}/koala/bin" />
    <delete dir="${sources}/koala/lib" />
    <delete dir="${sources}/koala/release" />
    <delete dir="${sources}/example/koala-example-build" />
    <delete dir="${sources}/example/bin" />
    <delete dir="${sources}/example/lib" />
    <delete dir="${sources}/example/release" />
  </target>

</project>
